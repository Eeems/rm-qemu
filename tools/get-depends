#!/bin/bash
usage(){
  echo "Usage: $0 <target> [--prefix=prefix] [--no-wait]" >/dev/stderr
}
if [ $# -eq 0 ];then
  usage
  exit 1
fi
T=${1}
shift
wait=true
prefix=""
while [ $# -gt 0 ];do
  case "$1" in
  "--prefix="*)
    prefix="${1:9}"
    ;;
  "--no-wait")
    wait=false
    ;;
  *)
    usage
    exit 1
  esac
  shift
done
depends(){
  while read -r d;do
    if [[ "$d" == ".WAIT" ]];then
      echo ".WAIT"
    elif [[ "$d" != "" ]];then
      echo "${prefix}${d}"
    fi
  done < <(make -C "$T" depends | xargs -n1)
}
if $wait;then
  depends | xargs
else
  depends | grep -v .WAIT | xargs
fi
