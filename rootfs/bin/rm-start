#!/bin/bash
set -e

if rm-is-running; then
  echo "Error: rm is running" >/dev/stderr
  exit 1
elif ! rm-image-path >/dev/null; then
  exit 1
fi

STATEDIR=${STATEDIR:-/run/rm}
mkdir -p "$STATEDIR"

args=(
  -machine
  mcimx7d-sabre
  -cpu
  cortex-a9
  -smp
  2
  -m
  2048
  -kernel
  "${ROOTDIR}/artifact/zImage"
  -dtb
  "${ROOTDIR}/artifact/qemu.dtb"
  -drive
  "if=sd,file=$(rm-image-path),format=qcow2,index=2"
  -append
  "console=ttymxc0 rootfstype=ext4 root=/dev/mmcblk2p2 rw rootwait init=/sbin/init"
  -nic
  "user,hostfwd=tcp::${RM_SSH_PORT:-2222}-:22,hostfwd=tcp::${RM_EMU_PORT:-8888}-:8888"
  -monitor
  "unix:$STATEDIR/monitor,server=on,wait=off"
)
paused=false
if rm-is-paused; then
  paused=true
  args+=(-loadvm running)
fi
if [[ "$1" == "--verbose" ]]; then
  shift
  print_args() {
    echo "qemu-system-arm"
    for a in "${args[@]}"; do
      echo " $a"
    done
  }
else
  print_args() {
    :
  }
fi
start_ssh_socket() {
  socat UNIX-LISTEN:"${STATEDIR}/ssh",fork TCP-CONNECT:localhost:"${RM_SSH_PORT:-2222}" &
  pid=$!
  disown "$pid"
  echo "$pid" >"${STATEDIR}/ssh.pid"
}
case "$1" in
-D | --detached)
  args+=(
    -chardev
    "socket,id=serial0,path=$STATEDIR/serial,server=on,wait=off"
    -serial
    chardev:serial0
    -parallel
    null
    -display
    none
    -daemonize
  )
  print_args
  start_ssh_socket
  qemu-system-arm "${args[@]}"
  if $paused; then
    rm-monitor commit sd2
  fi
  if [[ "$2" == "--wait" ]]; then
    echo "Waiting for ssh to start..." >/dev/stderr
    exec rm-wait-ssh
  fi
  ;;
"")
  if $paused; then
    {
      sleep 1
      rm-monitor commit sd2 || true
    } &
  fi
  args+=(
    -serial
    mon:stdio
    -nographic
  )
  print_args
  start_ssh_socket
  exec qemu-system-arm "${args[@]}"
  ;;
*)
  echo "Usage: rm-start [--verbose] [-D|--detached  [--wait]]" >/dev/stderr
  ;;
esac
