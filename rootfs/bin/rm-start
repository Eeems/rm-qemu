#!/bin/bash
set -e

if rm-is-running; then
  echo "Error: rm is running" >/dev/stderr
  exit 1
fi

args=""
paused=false
if rm-is-paused; then
  paused=true
  args="-loadvm running"
fi
mkdir -p /run/rm

case "$1" in
-D | --detached)
  qemu-system-arm \
    -machine mcimx7d-sabre \
    -cpu cortex-a9 \
    -smp 2 \
    -m 2048 \
    -kernel /zImage \
    -dtb /qemu.dtb \
    -drive if=sd,file=/rootfs.qcow2,format=qcow2,index=2 \
    -append "console=ttymxc0 rootfstype=ext4 root=/dev/mmcblk2p2 rw rootwait init=/sbin/init" \
    -nic user,hostfwd=tcp::22-:22,hostfwd=tcp::8888-:8888 \
    -monitor unix:/run/rm/monitor,server=on,wait=off \
    -chardev socket,id=serial0,path=/run/rm/serial,server=on,wait=off \
    -serial chardev:serial0 \
    -parallel null \
    -display none \
    -daemonize \
    "$args"
  if $paused; then
    rm-monitor commit sd2
  fi
  if [[ "$2" == "--wait" ]]; then
    echo "Waiting for ssh to start..." >/dev/stderr
    while ! rm-exec true >/dev/null 2>&1; do
      sleep 1
    done
  fi
  ;;
"")
  if $paused; then
    {
      sleep 1
      rm-monitor commit sd2 || true
    } &
  fi
  qemu-system-arm \
    -machine mcimx7d-sabre \
    -cpu cortex-a9 \
    -smp 2 \
    -m 2048 \
    -kernel /zImage \
    -dtb /qemu.dtb \
    -drive if=sd,file=/rootfs.qcow2,format=qcow2,index=2 \
    -append "console=ttymxc0,115200 rootfstype=ext4 root=/dev/mmcblk2p2 rw rootwait init=/sbin/init" \
    -nic user,hostfwd=tcp::22-:22,hostfwd=tcp::8888-:8888 \
    -monitor unix:/run/rm/monitor,server=on,wait=off \
    -serial mon:stdio \
    -nographic \
    "$args"
  ;;
*)
  echo "Usage: rm-start [-D|--detached] [--wait]" >/dev/stderr
  ;;
esac
