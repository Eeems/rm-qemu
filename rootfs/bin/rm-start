#!/bin/bash
set -e

if rm-is-running; then
  echo "Error: rm is running" >/dev/stderr
  exit 1
fi

args=""
paused=false
if rm-is-paused; then
  paused=true
  args="-loadvm running"
fi

STATEDIR=${STATEDIR:-/run/rm}
mkdir -p $STATEDIR

SSH_PORT=${SSH_PORT:-22}
case "$1" in
-D | --detached)
  qemu-system-arm \
    -machine mcimx7d-sabre \
    -cpu cortex-a9 \
    -smp 2 \
    -m 2048 \
    -kernel /zImage \
    -dtb "${ROOTDIR}/qemu.dtb" \
    -drive "if=sd,file=${STATEDIR}/rootfs.qcow2,format=qcow2,index=2" \
    -append "console=ttymxc0 rootfstype=ext4 root=/dev/mmcblk2p2 rw rootwait init=/sbin/init" \
    -nic user,hostfwd=tcp::${SSH_PORT}-:${SSH_PORT},hostfwd=tcp::8888-:8888 \
    -monitor unix:$STATEDIR/monitor,server=on,wait=off \
    -chardev socket,id=serial0,path=$STATEDIR/serial,server=on,wait=off \
    -serial chardev:serial0 \
    -parallel null \
    -display none \
    -daemonize \
    "$args"
  if $paused; then
    rm-monitor commit sd2
  fi
  if [[ "$2" == "--wait" ]]; then
    echo "Waiting for ssh to start..." >/dev/stderr
    ret=1
    set +e
    while [ $ret -ne 0 ]; do
      output=$(rm-exec true 2>&1)
      ret=$?
      if [[ "$output" == "root@localhost: Permission denied (publickey)." ]];then
        echo "Error: Unable to connect with publickey." >/dev/stderr
        echo "  Please rm-monitor q && rm-ensure-ssh and then try again." >/dev/stderr
        exit 1
      fi
      sleep 1
    done
  fi
  ;;
"")
  if $paused; then
    {
      sleep 1
      rm-monitor commit sd2 || true
    } &
  fi
  qemu-system-arm \
    -machine mcimx7d-sabre \
    -cpu cortex-a9 \
    -smp 2 \
    -m 2048 \
    -kernel /zImage \
    -dtb "${ROOTDIR}/qemu.dtb" \
    -drive "if=sd,file=${STATEDIR}/rootfs.qcow2,format=qcow2,index=2" \
    -append "console=ttymxc0,115200 rootfstype=ext4 root=/dev/mmcblk2p2 rw rootwait init=/sbin/init" \
    -nic user,hostfwd=tcp::${SSH_PORT}-:${SSH_PORT},hostfwd=tcp::8888-:8888 \
    -monitor unix:$STATEDIR/monitor,server=on,wait=off \
    -serial mon:stdio \
    -nographic \
    "$args"
  ;;
*)
  echo "Usage: rm-start [-D|--detached] [--wait]" >/dev/stderr
  ;;
esac
