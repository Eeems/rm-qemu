#!/bin/bash
set -e
VERSION="${1:?Usage: initialize-image <version>}"
DATADIR="${DATADIR:-/data}"

if rm-is-running && rm-image-path 2>/dev/null && [[ "$DATADIR/rootfs-$VERSION.qcow2" == "$(rm-image-path)" ]]; then
  echo "Image is in use" >/dev/stderr
  exit
fi

CACHEDIR="${CACHEDIR:-/cache}"
image="$CACHEDIR/$VERSION"
mkdir -p "$CACHEDIR"
if ! [ -f "$image" ]; then
  echo "Downloading update image..." >/dev/stderr
  download=$(mktemp -d)
  trap 'rmdir $download' EXIT
  codexctl download --hardware rm2 --out "$download" "$VERSION"
  mv "$download"/* "$image"
  trap - EXIT
  rmdir "$download"
fi
echo "Extracting image..." >/dev/stderr
extracted=$(mktemp -d)/image
# Remove the extracted image when we are done
# shellcheck disable=SC2064,SC2086
trap "rm -r '$(dirname $extracted)'" EXIT
codexctl extract --out "$extracted" "$image"
rootfs="$DATADIR/$VERSION.qcow2"
echo "Creating $VERSION.qcow2..." >/dev/stderr
pushd "$DATADIR" >/dev/null
qemu-img create \
  --format qcow2 \
  --backing "${ROOTDIR}/artifact/base.qcow2" \
  --backing-format qcow2 \
  --options compression_type=zstd \
  "$rootfs" \
  8G
# shellcheck disable=SC2064,SC2086
trap "rm -r '$(dirname $extracted)' '${rootfs}'" EXIT
popd >/dev/null
rm-busybox-start "$rootfs"
echo "Initializing $VERSION.qcow2..." >/dev/stderr
hash=$(sha256sum "$extracted" | cut -d' ' -f1)
dd if="$extracted" bs=160000 | gzip -1 | rm-busybox-exec "gunzip -c | dd of=/dev/mmcblk2p2 bs=160000"
rm-busybox-exec <<EOF
  set -e
  cd /mnt
  echo "$hash  /dev/mmcblk2p2" | sha256sum -c
  dd if=/dev/mmcblk2p2 of=/dev/mmcblk2p3 bs=160000
  echo "$hash  /dev/mmcblk2p3" | sha256sum -c
  mkdir -p rootA rootB home
  mount /dev/mmcblk2p2 rootA
  mount /dev/mmcblk2p3 rootB
EOF
rm -r "$(dirname "$extracted")"
# shellcheck disable=SC2064,SC2086
trap "rm '${rootfs}'" EXIT
for dev in A B; do
  echo "Setting up root$dev partition..." >/dev/stderr
  rm-busybox-upload "${ROOTDIR}/artifact/rm2fb.tar.gz" /tmp
  rm-busybox-exec <<EOF
    set -e
    cd /mnt/root${dev}
    tar xzhf /tmp/rm2fb.tar.gz -C .
    ln -s /lib/systemd/system/rm2fb.socket etc/systemd/system/sockets.target.wants/rm2fb.socket
    ln -s /dev/null etc/systemd/system/remarkable-fail.service
    ln -s /dev/null etc/systemd/system/system-hardening.service
    ln -s /dev/null etc/systemd/system/wacom_flash.service
    ln -s /dev/null etc/systemd/system/memfaultd.service
    ln -s /dev/null etc/systemd/system/crashuploader.service
    ln -s /dev/null etc/systemd/system/wpa_supplicant.service
    ln -s /dev/null etc/systemd/system/migrate_wifi.service
    ln -s /dev/null etc/systemd/system/swupdate.service
    ln -s /dev/null etc/systemd/system/swupdate.socket
    ln -sf /dev/null etc/systemd/system/update-engine.service
    ln -s /dev/null etc/systemd/system/prepare_wifi.service
    ln -s /dev/null etc/systemd/system/dropbear-wlan.socket
    ln -s /dev/null etc/systemd/system/dropbear-wlan@.service
    ln -s /dev/null etc/systemd/system/dropbear-usb0.socket
    ln -s /dev/null etc/systemd/system/dropbear-usb0@.service
    ln -s /dev/null etc/systemd/system/dropbear-usb1.socket
    ln -s /dev/null etc/systemd/system/dropbear-usb1.service
    ln -s /dev/null etc/systemd/system/xochitl.service
    sed -i 's|/dev/unknown|#/dev/mmcblk2p4|' etc/fstab
    mkdir -p etc/systemd/system/xochitl.service.d
EOF
  rm-busybox-upload "${ROOTDIR}/artifact/rm2fb.conf" /mnt/root${dev}/etc/systemd/system/xochitl.service.d/rm2fb.conf
  if version-test "$VERSION" -ge 3.22.0.0; then
    echo "Adding dropbear.socket..." >/dev/stderr
    rm-busybox-upload "${ROOTDIR}/artifact/dropbear.socket" /mnt/root${dev}/lib/systemd/system/dropbear.socket
    rm-busybox-exec <<EOF
      set -e
      ln -s /lib/systemd/system/dropbear.socket /mnt/root${dev}/etc/systemd/system/sockets.target.wants/dropbear.socket
EOF
  elif version-test "$VERSION" -lt 3.13.0.0; then
    echo "Patching dhcpcd.service..." >/dev/stderr
    rm-busybox-exec <<EOF
      set -e
      sed -i 's/wlan/eth/' /lib/systemd/system/dhcpcd.service
EOF
  fi
done
echo "Stopping busybox..." >/dev/stderr
rm-busybox-stop

echo "Setting temporary boot image..." >/dev/stderr
STATEDIR=${STATEDIR:-/run/rm}
mkdir -p "$STATEDIR"
if [ -f "${STATEDIR}/rootfs.qcow2" ]; then
  previous="$(rm-image-path)"
  # shellcheck disable=SC2064,SC2086
  trap "rm '${rootfs}'; ln -sf '${previous}' '${STATEDIR}/rootfs.qcow2'" EXIT
fi
ln -sf "$rootfs" "${STATEDIR}/rootfs.qcow2"

echo "Starting QEMU for setup..." >/dev/stderr

RM_EXEC_ENABLED_PASSWORD=1 \
  rm-start --detached --wait

echo "Finalizing mmcblk2p2..." >/dev/stderr

RM_EXEC_ENABLED_PASSWORD=1 \
  rm-exec <<EOT
  set -e
  sed -i 's|#/dev/mmcblk2p4|/dev/mmcblk2p4|' /etc/fstab
  rm /etc/systemd/system/xochitl.service
EOT

echo "Finalizing mmcblk2p3..." >/dev/stderr
rm-exec <<EOT
  mount /dev/mmcblk2p3 /mnt
  sed -i 's|#/dev/mmcblk2p4|/dev/mmcblk2p4|' /mnt/etc/fstab
  rm /mnt/etc/systemd/system/xochitl.service
  umount /mnt
EOT

echo "Setting up mmcblk2p4 partition..." >/dev/stderr
rm-exec <<EOT
  mkfs.ext4 -E nodiscard /dev/mmcblk2p4
EOT
trap - EXIT
rm-stop --wait
shrink-image "$rootfs"
