#!/bin/bash
set -e
VERSION="${1:?Usage: initialize-image <version>}"

if rm-is-running;then
  echo "Error: rm is running"
  exit 1
fi

version() { echo "$@" | awk -F. '{ printf("%d%04d%04d%04d\n", $1,$2,$3,$4); }'; }
version_test() {
  # shellcheck disable=SC1072,SC1073
  [ "$(version "$1")" "$2" "$(version "$3")" ]
}

CACHEDIR="${CACHEDIR:-/cache}"
mkdir -p "$CACHEDIR"
image="$CACHEDIR/$VERSION"
if ! [ -f "$image" ]; then
  echo "Downloading update image..." >/dev/stderr
  download=$(mktemp -d)
  trap 'rmdir $download' EXIT
  codexctl download --hardware rm2 --out "$download" "$VERSION"
  [ -f "$download"/* ]
  mv "$download"/* "$image"
  trap - EXIT
  rmdir "$download"
fi
DATADIR="${DATADIR:-/data}"
echo "Extracting image..." >/dev/stderr
extracted=$(mktemp -d)/image
trap 'rm -r $(dirname $extracted)' EXIT
codexctl extract --out "$extracted" "$image"
rootfs="$DATADIR/$VERSION.qcow2"
echo "Creating $VERSION.qcow2..." >/dev/stderr
if [ ! -f "$DATADIR/base.qcow2" ];then
  cp "${ROOTDIR}/base.qcow2" "$DATADIR"
fi
pushd $DATADIR >/dev/null
qemu-img create \
  --format qcow2 \
  --backing base.qcow2 \
  --backing-format qcow2 \
  --options compression_type=zstd \
  "$rootfs" \
  8G
popd >/dev/null
echo "Initializing $VERSION.qcow2..." >/dev/stderr
guestfish --rw --blocksize=512 --add "$rootfs" <<EOF
run
upload "$extracted" /dev/sda2
upload "$extracted" /dev/sda3
EOF
for dev in 2 3; do
  echo "Setting up mmcblk2p$dev partition..." >/dev/stderr
  guestfish --rw --blocksize=512 --add "$rootfs" <<EOF
    run
    mount /dev/sda$dev /
    upload ${ROOTDIR}/rm2fb.tar.gz /rm2fb.tar.gz
    ln-s /lib/systemd/system/rm2fb.socket /etc/systemd/system/sockets.target.wants/rm2fb.socket
    ln-s /dev/null /etc/systemd/system/remarkable-fail.service
    ln-s /dev/null /etc/systemd/system/system-hardening.service
    ln-s /dev/null /etc/systemd/system/wacom_flash.service
    ln-s /dev/null /etc/systemd/system/memfaultd.service
    ln-s /dev/null /etc/systemd/system/crashuploader.service
    ln-s /dev/null /etc/systemd/system/wpa_supplicant.service
    ln-s /dev/null /etc/systemd/system/migrate_wifi.service
    ln-s /dev/null /etc/systemd/system/swupdate.service
    ln-s /dev/null /etc/systemd/system/swupdate.socket
    ln-sf /dev/null /etc/systemd/system/update-engine.service
    ln-s /dev/null /etc/systemd/system/prepare_wifi.service
    ln-s /dev/null /etc/systemd/system/dropbear-wlan.socket
    ln-s /dev/null /etc/systemd/system/dropbear-wlan@.service
    ln-s /dev/null /etc/systemd/system/dropbear-usb0.socket
    ln-s /dev/null /etc/systemd/system/dropbear-usb0@.service
    ln-s /dev/null /etc/systemd/system/dropbear-usb1.socket
    ln-s /dev/null /etc/systemd/system/dropbear-usb1.service
    ln-s /dev/null /etc/systemd/system/xochitl.service
    download /etc/fstab /tmp/fstab
    ! sed -i 's|/dev/unknown|#/dev/mmcblk2p4|' /tmp/fstab
    upload /tmp/fstab /etc/fstab
    mkdir-p /etc/systemd/system/xochitl.service.d
    upload ${ROOTDIR}/rm2fb.conf /etc/systemd/system/xochitl.service.d/rm2fb.conf
EOF
  if version_test "$VERSION" -ge 3.22.0.0; then
    echo "Adding dropbear.socket..." >/dev/stderr
    guestfish --rw --blocksize=512 --add "$rootfs" <<EOF
      run
      mount /dev/sda$dev /
      upload ${ROOTDIR}/dropbear.socket /lib/systemd/system/dropbear.socket
      ln-s /lib/systemd/system/dropbear.socket /etc/systemd/system/sockets.target.wants/dropbear.socket
EOF
  elif ! version_test "$VERSION" -ge 3.13.0.0; then
    echo "Patching dhcpcd.service..." >/dev/stderr
    guestfish --rw --blocksize=512 --add "$rootfs" <<EOF
      run
      mount /dev/sda$dev /
      download /lib/systemd/system/dhcpcd.service /tmp/dhcpcd.service
      ! sed -i 's/wlan/eth/' /tmp/dhcpcd.service
      upload /tmp/dhcpcd.service /lib/systemd/system/dhcpcd.service
EOF
  fi
done
if [ -f "${STATEDIR}/rootfs.qcow2" ];then
  previous=$(readlink "${STATEDIR}/rootfs.qcow2")
  trap "ln -sf '$previous' '${STATEDIR}/rootfs.qcow2'" EXIT
fi
ln -sf "$rootfs" "${STATEDIR}/rootfs.qcow2"
rm-start --detached --wait
rm-exec <<EOT
  set -e
  echo "Finalizing mmcblk2p2..." >/dev/stderr
  tar xzhf /rm2fb.tar.gz -C /
  sed -i 's|#/dev/mmcblk2p4|/dev/mmcblk2p4|' /etc/fstab
  rm /etc/systemd/system/xochitl.service

  echo "Finalizing mmcblk2p3..." >/dev/stderr
  mount /dev/mmcblk2p3 /mnt
  sed -i 's|#/dev/mmcblk2p4|/dev/mmcblk2p4|' /mnt/etc/fstab
  rm /mnt/etc/systemd/system/xochitl.service
  tar xzhf /rm2fb.tar.gz -C /mnt
  umount /mnt

  echo "Setting up mmcblk2p4 partition..." >/dev/stderr
  mkfs.ext4 -E nodiscard /dev/mmcblk2p4
EOT
rm-stop --wait
shrink-image "$rootfs"
