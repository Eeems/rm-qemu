#!/bin/sh
set -e
VERSION="$1"
mkdir -p /cache
image="/cache/$VERSION.img"
if ! [ -f "$image" ]; then
  download=$(mktemp -d)
  codexctl download --hardware rm2 --out "$download" "$VERSION"
  codexctl extract --out "$image" "$download"/*
  rm -r "$download"
fi
qemu-img create \
  --format qcow2 \
  --backing /base.qcow2 \
  --backing-format qcow2 \
  --options compression_type=zstd \
  /data/rootfs.qcow2 \
  8G
guestfish --rw --blocksize=512 --add /data/rootfs.qcow2 <<EOF
run
upload "$image" /dev/sda2
upload "$image" /dev/sda3
mount /dev/sda4 /
mkdir-p /root/.local/bin
mkdir-p /root/.config
upload /opkg.conf /root/.config/opkg.conf
upload /rm2display.ipk /root/rm2display.ipk
upload /opkg /root/.local/bin/opkg
chmod 0755 /root/.local/bin/opkg
EOF
for dev in sda2 sda3; do
  guestfish --rw --blocksize=512 --add /data/rootfs.qcow2 <<EOF
    run
    mount /dev/$dev /
    ln-s /dev/null /etc/systemd/system/remarkable-fail.service
    ln-s /dev/null /etc/systemd/system/system-hardening.service
    ln-s /dev/null /etc/systemd/system/wacom_flash.service
    ln-s /dev/null /etc/systemd/system/memfaultd.service
    ln-s /dev/null /etc/systemd/system/crashuploader.service
    ln-s /dev/null /etc/systemd/system/wpa_supplicant.service
    ln-s /dev/null /etc/systemd/system/migrate_wifi.service
    ln-s /dev/null /etc/systemd/system/swupdate.service
    ln-s /dev/null /etc/systemd/system/swupdate.socket
    ln-sf /dev/null /etc/systemd/system/update-engine.service
    ln-s /dev/null /etc/systemd/system/prepare_wifi.service
    download /etc/fstab /tmp/fstab
    ! sed -i 's|/dev/unknown|/dev/mmcblk2p4|' /tmp/fstab
    upload /tmp/fstab /etc/fstab
EOF
done
rm-start --detached --wait
rm-exec <<EOT
  set -e
  mount /home
  export PATH
  PATH="/home/root/.local/bin:\$PATH)"
  cd /home/root
  mkdir -p /opt/tmp
  opkg install \
    --conf /home/root/.config/opkg.conf \
    --force-depends \
    --nodeps \
    rm2display.ipk \
  || true
  rm rm2display.ipk
  mkdir -p /etc/systemd/system/xochitl.service.d/
  echo "[Service]" > /etc/systemd/system/xochitl.service.d/rm2display.conf
  echo "Environment=LD_PRELOAD=/opt/lib/librm2fb_client.so" >> /etc/systemd/system/xochitl.service.d/rm2display.conf
EOT
rm-stop --wait
shrink-image /data/rootfs.qcow2 \
  --backing /base.qcow2 \
  --backing-format qcow2
