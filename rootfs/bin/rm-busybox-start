#!/bin/bash
set -e
if [ $# -gt 0 ]; then
  image="$1"
elif rm-image-path >/dev/null; then
  image="$(rm-image-path)"
else
  exit 1
fi
if [ ! -f "$image" ]; then
  echo "Error: $image is not found" >/dev/stderr
  exit 1
fi
qemu-system-arm \
  -machine \
  virt \
  -smp \
  "cpus=$(nproc)" \
  -m \
  size=2048 \
  -kernel \
  "${ROOTDIR}/artifact/busybox-zImage" \
  -initrd \
  "${ROOTDIR}/artifact/busybox.img" \
  -append \
  "quiet" \
  -device \
  virtio-net-device,netdev=net0 \
  -netdev \
  "user,id=net0,hostfwd=tcp::${RM_BUSYBOX_PORT:-2221}-:22" \
  -device \
  virtio-blk-device,drive=hd2 \
  -drive \
  "if=none,file=$image,format=qcow2,id=hd2" \
  -device \
  virtio-blk-device,drive=hd1 \
  -drive \
  if=none,file=null-co://,format=raw,id=hd1 \
  -device \
  virtio-blk-device,drive=hd0 \
  -drive \
  if=none,file=null-co://,format=raw,id=hd0 \
  -serial \
  null \
  -parallel \
  null \
  -display \
  none \
  -daemonize

echo "Waiting for busybox to be ready..."
rm-wait-busybox
