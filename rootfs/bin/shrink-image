#!/bin/bash
set -e
if [ $# -ne 1 ];then
  echo "Usage: shrink-image <image>" >/dev/stderr
  exit 1
fi
IMAGE="$(readlink --canonicalize-existing "$1")"
if rm-is-running && [[ "$IMAGE" == "$(rm-image-path)" ]];then
  echo "Image is in use" >/dev/stderr
  exit
fi
if [[ "$(qemu-img snapshot -l "$IMAGE")" != "" ]];then
  echo "Image has snapshots" >/dev/stderr
  exit
fi
args=$(qemu-img info "$IMAGE" | awk '/backing file:/{print "--backing",$3} /backing file format:/{print "--backing-format",$4}' | xargs)
BAK=$(mktemp -d)
BEFORE=$(du -hs "$IMAGE" | awk '{print $1}')
mv "$IMAGE" "$BAK"
# shellcheck disable=SC2086
qemu-img convert \
  --source-format qcow2 \
  -O qcow2 \
  -c \
  -o compression_type=zstd \
  $args \
  "$BAK"/* \
  "$IMAGE"
rm -r "$BAK"
AFTER=$(du -hs "$IMAGE" | awk '{print $1}')
echo "Shrunk $(basename "$IMAGE"): $BEFORE -> $AFTER"
