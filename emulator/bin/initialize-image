#!/bin/bash
set -e
VERSION="${1:?Usage: initialize-image <version>}"
DATADIR="${DATADIR:-/data}"

if rm-is-running && rm-image-path 2>/dev/null && [[ "$DATADIR/rootfs-$VERSION.qcow2" == "$(rm-image-path)" ]]; then
  echo "Image is in use" >/dev/stderr
  exit
fi
DATADIR="${DATADIR:-/data}"
rootfs="$DATADIR/$VERSION.qcow2"
# shellcheck disable=SC2064,SC2086
trap "rm '${rootfs}'" EXIT
initialize-image-base "$VERSION" --no-stop
initialize-image-patch "$VERSION" --no-start
trap - EXIT
shrink-image "$rootfs"
