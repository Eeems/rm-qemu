#!/bin/bash
set -e
is-running() {
  if ! killall -0 qemu-system-arm &>/dev/null; then
    echo "qemu-system-arm not running" >/dev/stderr
    return 1
  elif ! rm-image-path &>/dev/null; then
    echo "no active image" >/dev/stderr
    return 1
  fi
  image=$(rm-image-path)
  for pid in $(pidof qemu-system-arm); do
    for l in /proc/"$pid"/fd/*; do
      if [[ "$(readlink "$l")" == "$image" ]]; then
        echo "image in use" >/dev/stderr
        return 0
      fi
    done
  done
  echo "image not in use" >/dev/stderr
  return 1
}
if [ $# -eq 1 ]; then
  case "$1" in
  "--help")
    echo "Usage: rm-is-running [--verbose|--help]"
    exit
    ;;
  "--verbose")
    if is-running; then
      echo "rm is running"
      exit
    fi
    echo "rm is not running"
    exit 1
    ;;
  "--stdout")
    exec rm-is-running --verbose 2>/dev/null
    ;;
  *)
    rm-is-running --help
    exit 1
    ;;
  esac
elif [ $# -gt 1 ]; then
  rm-is-running --help
  exit 1
fi
is-running 2>/dev/null
