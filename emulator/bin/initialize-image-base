#!/bin/bash
set -e
exec 1>&2
usage() {
  echo "Usage: initialize-image-base <version> [--no-stop]"
  exit 1
}
if [ $# -ne 1 ] && [ $# -ne 2 ]; then
  usage
fi
VERSION="${1:?Error: version is empty}"
shift
stop=true
if [ $# -eq 1 ] && [[ "$1" == "--no-stop" ]]; then
  stop=false
elif [ $# -eq 1 ]; then
  usage
fi
DATADIR="${DATADIR:-/data}"

if rm-is-running && rm-image-path 2>/dev/null && [[ "$DATADIR/$VERSION.qcow2" == "$(rm-image-path)" ]]; then
  echo "Image is in use"
  exit
fi

CACHEDIR="${CACHEDIR:-/cache}"
image="$CACHEDIR/$VERSION"
mkdir -p "$CACHEDIR"
if ! [ -f "$image" ]; then
  echo "Downloading update image..."
  download=$(mktemp -d)
  trap 'rmdir $download' EXIT
  codexctl download --hardware rm2 --out "$download" "$VERSION"
  mv "$download"/* "$image"
  trap - EXIT
  rmdir "$download"
fi
echo "Extracting image..."
extracted=$(mktemp -d)/image
# Remove the extracted image when we are done
# shellcheck disable=SC2064,SC2086
trap "rm -rf '$(dirname \"$extracted\")'" EXIT
codexctl extract --out "$extracted" "$image"
# truncate -s ">283115008" "$extracted"
rootfs="$DATADIR/$VERSION.qcow2"
echo "Creating $VERSION.qcow2..."
pushd "$DATADIR" >/dev/null
cp "${ROOTDIR}/artifact/base.qcow2" "$rootfs"
# shellcheck disable=SC2064,SC2086
trap "rm -rf '$(dirname \"$extracted\")' '${rootfs}'" EXIT
popd >/dev/null
rm-busybox-start "$rootfs"
echo "Initializing $VERSION.qcow2..."
hash=$(sha256sum "$extracted" | cut -d' ' -f1)
size=$(stat -c "%s" "$extracted")
dd if="$extracted" bs=160000 | gzip -1 | rm-busybox-exec "gunzip -c | dd of=/dev/mmcblk2p2 bs=160000"
rm-busybox-exec <<EOF
  set -e
  hash=\$(head -c $size /dev/mmcblk2p2 | sha256sum | cut -d' ' -f1)
  if [[ "\$hash" != "$hash" ]];then
    echo "Error: sha256sum of mmcblk2p2 does not match expected"
    echo "  Expected: $hash"
    echo "  actual: \$hash"
    echo "  size: $size"
    exit 1
  fi
  if ! dd if=/dev/mmcblk2p2 of=/dev/mmcblk2p3 bs=160000;then
    echo "Error: Failed to copy mmcblk2p2 to mmcblk2p3"
  fi
  hash=\$(head -c $size /dev/mmcblk2p3 | sha256sum | cut -d' ' -f1)
  if [[ "\$hash" != "$hash" ]];then
    echo "Error: sha256sum of mmcblk2p3 does not match expected"
    echo "  Expected: $hash"
    echo "  actual: \$hash"
    echo "  size: $size"
    exit 1
  fi
  if ! /sbin/fsck.ext4 -p /dev/mmcblk2p2;then
    echo "Error: mmcblk2p2 fsck failed"
    exit 1
  fi
  if ! /sbin/fsck.ext4 -p /dev/mmcblk2p3;then
    echo "Error: mmcblk2p3 fsck failed"
    exit 1
  fi
  if ! /sbin/fsck.vfat -p /dev/mmcblk2p1;then
    echo "Error: mmcblk2p1 fsck failed"
    exit 1
  fi
EOF
rm -rf "$(dirname "$extracted")"
if $stop; then
  echo "Stopping busybox..."
  rm-busybox-stop
fi
trap - EXIT
