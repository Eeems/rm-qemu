#!/bin/bash
set -e
STATEDIR=${STATEDIR:-/run/rm}
mkdir -p "${STATEDIR}"
usage="Usage: rm-select --help
  entrypoint <version>"
if [ "$#" -eq 0 ]; then
	echo "$usage"
	exit 1
fi
if [ "$#" -eq 1 ] && [[ "$1" == "--help" ]]; then
	echo "$usage"
	exit
fi
VERSION=$1
shift
echo "Ensuring image is in a good state..."
rm-ensure-image "$VERSION" || true
VERSION_IMAGE="${DATADIR:-/data}/${VERSION}.qcow2"
if ! [ -f "$VERSION_IMAGE" ]; then
	echo "Creating base $VERSION image..."
	initialize-image "$VERSION"
fi
IMAGE="${DATADIR:-/data}/rootfs-$VERSION.qcow2"
if ! [ -f "$IMAGE" ]; then
	echo "Creating rootfs image..."
	pushd "${DATADIR:-/data}" >/dev/null
	qemu-img create \
		--format qcow2 \
		--backing "$VERSION_IMAGE" \
		--backing-format qcow2 \
		--options compression_type=zstd \
		"$IMAGE" \
		8G
	popd >/dev/null
fi
ln -sf "$IMAGE" "${STATEDIR}/rootfs.qcow2"
