#!/bin/bash
set -e
set -o pipefail
if [ $# -eq 0 ] || [ $(($# % 2)) -ne 0 ]; then
  echo "Usage: $0 [source destination]..." >/dev/stderr
  echo "  mmcblk2p1 is mounted to /mnt/boot" >/dev/stderr
  echo "  mmcblk2p2 is mounted to /mnt/rootA" >/dev/stderr
  echo "  mmcblk2p3 is mounted to /mnt/rootB" >/dev/stderr
  echo "  mmcblk2p4 is mounted to /mnt/home" >/dev/stderr
  exit 1
fi
upload() {
  while [ $# -gt 0 ]; do
    echo "mkdir-p $(dirname "$2")"
    if [ -d "$1" ]; then
      while read -r f; do
        upload "$1/$f" "$2/$f"
      done < <(ls "$1")
    elif [ -f "$1" ]; then
      echo "upload $1 $2"
    else
      echo "$1 is not a file or directory" >/dev/stderr
      exit 1
    fi
    shift 2
  done
}
script=$(upload "$@")
echo "$script" | rm-busybox
shrink-image "$(rm-image-path)"
