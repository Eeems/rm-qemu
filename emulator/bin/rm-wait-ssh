#!/bin/bash
usage() {
  echo "Usage: rm-wait-ssh [--help]" >/dev/stderr
  exit "${1:-0}"
}
if [ $# -ge 1 ]; then
  if [[ "$1" != "--help" ]]; then
    usage
  fi
  usage 1
fi
echo "Waiting for ssh to start..." >/dev/stderr
ret=1
fail_retry=5
deny_retry=2
while [ $ret -ne 0 ]; do
  output=$(rm-exec true 2>&1)
  ret=$?
  if [ $ret -eq 0 ]; then
    break
  fi
  if [[ "$output" == *"root@localhost: Permission denied (publickey)."* ]] ||
    [[ "$output" == *"root@localhost: Permission denied (publickey,password)."* ]] ||
    [[ "$output" == *"root@localhost: Permission denied (password)."* ]]; then
    deny_retry=$((deny_retry - 1))
    if [ $deny_retry -lt 0 ]; then
      echo "Error: Unable to connect with publickey." >/dev/stderr
      echo "  Please rm-monitor q && rm-ensure-ssh and then try again." >/dev/stderr
      echo "$output" >/dev/stderr
      exit 1
    fi
    echo "Warning $ret: Connection denied, retrying..."
    echo "root" | rm-serial
    echo "mkdir -p /home/root/.ssh" | rm-serial
    echo "chmod 0700 /home/root/.ssh" | rm-serial
    echo "cp /etc/dropbear/authorized_keys /home/root/.ssh/authorized_keys" | rm-serial
    echo "chmod 0600 /home/root/.ssh/authorized_keys" | rm-serial
    echo "exit" | rm-serial
  elif [[ "$output" == *"Segmentation fault"* ]] || [ $ret -eq 139 ]; then
    echo "Error: ssh executable is broken." >/dev/stderr
    echo "$output" >/dev/stderr
    exit 1
  elif ! rm-is-running; then
    echo "Error: rm is no longer running" >/dev/stderr
    rm-is-running --verbose >/dev/null
    exit 1
  elif [ $ret -ne 255 ]; then
    fail_retry=$((fail_retry - 1))
    if [ $fail_retry -lt 0 ]; then
      echo "Error $ret: Unable to connect, likely /home/root does not exist" >/dev/stderr
      echo "  You may need to use rm-serial to login on the serial console to fix things" >/dev/stderr
      echo "$output" >/dev/stderr
      exit 1
    fi
    echo "Warning $ret: Unable to connect, retrying..."
    rm-serial root
    rm-serial <<EOF
      mkdir -p /home/root/.ssh
      chmod 0700 /home/root/.ssh
      cp /etc/dropbear/authorized_keys /home/root/.ssh/authorized_keys
      chmod 0600 /home/root/.ssh/authorized_keys
      exit
EOF
  fi
  sleep 1
done
