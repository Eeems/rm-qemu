#!/bin/bash
exec rm-busybox-exec <<EOF
  set -e
  cd /mnt
  mkdir -p boot rootA rootB home
  if ! mountpoint -q boot;then
    mount /dev/mmcblk2p1 boot
  fi
  if ! mountpoint -q rootA;then
    mount /dev/mmcblk2p2 rootA
  fi
  if ! mountpoint -q rootB;then
    mount /dev/mmcblk2p3 rootB
  fi
  if [[ "\$(fs-type /dev/mmcblk2p4)" != "ext4" ]];then
    /sbin/mkfs.ext4 -F /dev/mmcblk2p4
  elif ! grep -q /dev/mmcblk2p4 /proc/mounts; then
    /sbin/fsck.ext4 -p /dev/mmcblk2p4
  fi
  if ! mountpoint -q home;then
    mount /dev/mmcblk2p4 home
  fi
  mkdir -p home/root
EOF
