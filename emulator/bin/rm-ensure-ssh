#!/bin/sh
if ! [ -f ~/.ssh/id_rsa ]; then
  ssh-keygen -q \
    -f "$HOME/.ssh/id_rsa" \
    -N ''
fi
rm-guestfish <<EOF
  mkdir-p /home/root/.ssh
  chmod 0700 /home/root/.ssh
  upload $HOME/.ssh/id_rsa.pub /home/root/.ssh/authorized_keys
  chmod 0600 /home/root/.ssh/authorized_keys

  umount /home

  mkdir-p /home/root/.ssh
  chmod 0700 /home/root/.ssh
  upload $HOME/.ssh/id_rsa.pub /home/root/.ssh/authorized_keys
  chmod 0600 /home/root/.ssh/authorized_keys

  mkdir-p /mnt/home/root/.ssh
  chmod 0700 /mnt/home/root/.ssh
  upload $HOME/.ssh/id_rsa.pub /mnt/home/root/.ssh/authorized_keys
  chmod 0600 /mnt/home/root/.ssh/authorized_keys
EOF
