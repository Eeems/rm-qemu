#!/bin/sh
set -e
if ! [ -f ~/.ssh/id_rsa ]; then
  ssh-keygen -q \
    -f "$HOME/.ssh/id_rsa" \
    -N ''
fi
rm-busybox-start
rm-wait-busybox
rm-busybox-exec <<EOF
  mkdir -p home/root/.ssh
  chmod 0700 home/root/.ssh
  mkdir -p rootA/home/root/.ssh
  chmod 0700 rootA/home/root/.ssh
  mkdir -p rootB/home/root/.ssh
  chmod 0700 rootB/home/root/.ssh
EOF
rm-busybox-upload "$HOME/.ssh/id_rsa.pub" home/root/.ssh/authorized_keys
rm-busybox-upload "$HOME/.ssh/id_rsa.pub" rootA/home/root/.ssh/authorized_keys
rm-busybox-upload "$HOME/.ssh/id_rsa.pub" rootB/home/root/.ssh/authorized_keys
rm-busybox-exec <<EOF
  chmod 0600 home/root/.ssh/authorized_keys
  chmod 0600 roomA/home/root/.ssh/authorized_keys
  chmod 0600 rootB/home/root/.ssh/authorized_keys
EOF
rm-busybox-stop
