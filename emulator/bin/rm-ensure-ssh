#!/bin/sh
set -e
if ! [ -f ~/.ssh/id_rsa ]; then
  ssh-keygen -q \
    -f "$HOME/.ssh/id_rsa" \
    -N ''
fi
rm-busybox-start
rm-wait-busybox
rm-busybox-mount
rm-busybox-exec <<EOF
  set -e
  cd /mnt
  mkdir -p \
    home/root/.ssh \
    rootA/home/root/.ssh \
    rootA/etc/dropbear \
    rootB/home/root/.ssh \
    rootB/etc/dropbear
  chmod 0700 \
    home/root/.ssh \
    rootA/home/root/.ssh \
    rootB/home/root/.ssh
EOF
rm-busybox-upload "$HOME/.ssh/id_rsa.pub" /tmp/id_rsa.pub
rm-busybox-exec <<EOF
  set -e
  cd /mnt
  chmod 0600 /tmp/id_rsa.pub
  cp -a /tmp/id_rsa.pub home/root/.ssh/authorized_keys
  for d in A B;do
    cp -a /tmp/id_rsa.pub root\$d/home/root/.ssh/authorized_keys
    cp -a /tmp/id_rsa.pub root\$d/etc/dropbear/authorized_keys
    rm-chroot \$d systemctl unmask dropbear.socket
    rm-chroot \$d systemctl enable dropbear.socket
  done
  rm /tmp/id_rsa.pub
EOF
rm-busybox-stop
