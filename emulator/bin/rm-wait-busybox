#!/bin/bash
usage() {
  echo "Usage: rm-wait-ssh [--help]" >/dev/stderr
  exit ${1:-0}
}
if [ $# -ge 1 ]; then
  if [[ "$1" != "--help" ]]; then
    usage
  fi
  usage 1
fi
ret=1
while [ $ret -ne 0 ]; do
  output=$(rm-busybox-exec true 2>&1)
  ret=$?
  if [[ "$output" == "root@localhost: Permission denied (publickey)." ]]; then
    echo "Error: Unable to connect with publickey." >/dev/stderr
    echo "  Please rm-monitor q && rm-ensure-ssh and then try again." >/dev/stderr
    echo "$output" >/dev/stderr
    exit 1
  elif [[ "$output" == *"Segmentation fault"* ]] || [ $ret -eq 139 ]; then
    echo "Error: ssh executable is broken." >/dev/stderr
    echo "$output" >/dev/stderr
    exit 1
  fi
  sleep 1
done
