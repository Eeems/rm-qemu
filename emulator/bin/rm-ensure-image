#!/bin/bash
set -e
usage() {
  echo "Usage: rm-ensure-image <version>" >/dev/stderr
  exit "${1:-0}"
}
if [ $# -eq 0 ]; then
  echo "Error: Version must be specified" >/dev/stderr
  usage 1
fi
VERSION="$1"
shift
do_rm=true
if [ $# -gt 1 ]; then
  echo "Error: Too many arguments" >/dev/stderr
  usage 1
elif [ $# -eq 1 ]; then
  if [[ "$1" == "--help" ]]; then
    usage
  elif [[ "$1" == "--no-remove" ]]; then
    do_rm=false
  else
    echo "Error: Unknown argument: '$1'" >/dev/stderr
    usage 1
  fi
fi

if rm-is-running && rm-image-path 2>/dev/null && [[ "${DATADIR:-/data}/rootfs-$VERSION.qcow2" == "$(rm-image-path)" ]]; then
  echo "Image is in use" >/dev/stderr
  exit
fi

verify() {
  if [ ! -f "$1" ]; then
    echo "$1 does not exist" >/dev/stderr
    return 0
  fi
  rm-busybox-start "$1"
  errors=()
  fstype() { echo "fs-type '/dev/mmcblk2p$1'" | rm-busybox-exec | xargs -n1 | grep ' TYPE=' | cut -d= -f2 | tail -n1; }
  is_fstype() {
    f=$(fstype "$1")
    if [[ "$f" != "$2" ]]; then
      errors+=("mmcblk2p$1 is not $2: ${f:-(none)}")
    fi
  }
  rm-wait-busybox
  is_fstype 1 vfat
  is_fstype 2 ext4
  is_fstype 3 ext4
  is_fstype 4 ext4
  rm-busybox-stop
  if [ ${#errors[@]} -eq 0 ]; then
    return 0
  fi
  echo "Errors found in $1"
  for e in "${errors[@]}"; do
    echo "  $e" >/dev/stderr
  done
  return 1
}
ret=0
for i in "${DATADIR:-/data}/"{rootfs-,}"$VERSION".qcow2; do
  if ! verify "$i"; then
    ret=1
    if $do_rm; then
      rm "$i"
    fi
  fi
done
exit $ret
