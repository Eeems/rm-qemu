#!/bin/bash
set -e
usage(){
  echo "Usage: rm-ensure-image <version>" >/dev/stderr
  exit ${1:-0}
}
if [ $# -eq 0 ]; then
  echo "Error: Version must be specified" >/dev/stderr
  usage 1
fi
VERSION="$1"
shift
do_rm=true
if [ $# -gt 1 ]; then
  echo "Error: Too many arguments" >/dev/stderr
  usage 1
elif [ $# -eq 1 ];then
  if [[ "$1" == "--help" ]]; then
    usage
  elif [[ "$1" == "--no-remove" ]]; then
    do_rm=false
  else
    echo "Error: Unknown argument: '$1'" >/dev/stderr
    usage 1
  fi
fi

if rm-is-running;then
  echo "Error: rm is running"
  exit 1
fi

verify(){
  if [ ! -f "$1" ];then
    echo "$1 does not exist"
    return 0
  fi
  filesystems=$(echo -e "run\nlist-filesystems" | guestfish -a "$1" --ro)
  fstype(){ [[ $(echo "$filesystems" | awk "/\/dev\/sda$1/{print \$2}") == "$2" ]]; }
  errors=()
  if ! fstype 1 vfat;then
    errors+=("mmcblk2p1 is not vfat")
  fi
  if ! fstype 2 ext4;then
    errors+=("mmcblk2p2 is not ext4")
  fi
  if ! fstype 3 ext4;then
    errors+=("mmcblk2p3 is not ext4")
  fi
  if ! fstype 4 ext4;then
    errors+=("mmcblk2p4 is not ext4")
  fi
  if [ ${#errors[@]} -eq 0 ];then
    return 0
  fi
  echo "Errors found in $1"
  for e in "${errors[@]}";do
    echo "  $e"
  done
  return 1
}
ret=0
for i in "${DATADIR:-/data}/"{rootfs-,}"$VERSION".qcow2;do
  if ! verify "$i";then
    ret=1
    if $do_rm;then
      rm "$i"
    fi
  fi
done
exit $ret
