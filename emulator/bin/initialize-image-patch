#!/bin/bash
set -e
exec 1>&2
usage() {
  echo "Usage: initialize-image-patch <version> [--no-start]"
  exit 1
}
if [ $# -ne 1 ] && [ $# -ne 2 ]; then
  usage
fi
VERSION="${1:?Error: version is empty}"
shift
start=true
if [ $# -eq 1 ] && [[ "$1" == "--no-start" ]]; then
  start=false
elif [ $# -eq 1 ]; then
  usage
fi
DATADIR="${DATADIR:-/data}"
rootfs="$DATADIR/$VERSION.qcow2"
echo "Patching $rootfs..."
if [ ! -f "$rootfs" ]; then
  echo "Error: ${rootfs} not found"
  exit 1
fi
if ! [ -f ~/.ssh/id_rsa ]; then
  ssh-keygen -q \
    -f "$HOME/.ssh/id_rsa" \
    -N ''
fi
if $start; then
  rm-busybox-start "$rootfs"
  rm-busybox-exec <<EOF
    set -e
    cd /mnt
EOF
fi
rm-busybox-mount
rm-busybox-upload "$HOME/.ssh/id_rsa.pub" /tmp/id_rsa.pub
rm-busybox-exec chmod 0600 /tmp/id_rsa.pub
for dev in A B; do
  echo "Setting up root$dev partition..."
  rm-busybox-upload "${ROOTDIR}/artifact/rm2fb.tar.gz" /tmp
  rm-busybox-exec <<EOF
    set -e
    cd /mnt/root${dev}
    tar xzhf /tmp/rm2fb.tar.gz -C .

    sed -i 's|/dev/unknown|/dev/mmcblk2p4|' etc/fstab
    mkdir -p etc/systemd/system/xochitl.service.d

    cp -a /tmp/id_rsa.pub etc/dropbear/authorized_keys
    mkdir -p etc/skel/.ssh/
    chmod 0700 etc/skel/.ssh/
    cp -a /tmp/id_rsa.pub etc/skel/.ssh/authorized_keys
EOF
  rm-busybox-exec rm-chroot ${dev} <<EOF
      rm -f /etc/systemd/system/update-engine.service
      systemctl mask \
        remarkable-fail.service \
        system-hardening.service \
        wacom_flash.service \
        memfaultd.service \
        crashuploader.service \
        wpa_supplicant.service \
        migrate_wifi.service \
        swupdate.service \
        swupdate.socket \
        kdump.service \
        factory-reset.service \
        update-engine.service \
        prepare_wifi.service \
        dropbear-wlan.socket \
        dropbear-wlan@.service \
        dropbear-usb0.socket \
        dropbear-usb0@.service \
        dropbear-usb1.socket \
        dropbear-usb1.service
      systemctl enable rm2fb.socket
EOF
  rm-busybox-upload "${ROOTDIR}/artifact/rm2fb.conf" /mnt/root${dev}/etc/systemd/system/xochitl.service.d/rm2fb.conf
  if version-test "$VERSION" -ge 3.22.0.0; then
    echo "Adding dropbear.socket..."
    rm-busybox-upload "${ROOTDIR}/artifact/dropbear.socket" /mnt/root${dev}/lib/systemd/system/dropbear.socket
    rm-busybox-exec rm-chroot ${dev} systemctl enable dropbear.socket
  elif version-test "$VERSION" -lt 3.12.4.3; then
    echo "Patching dhcpcd.service..."
    rm-busybox-exec sed -i 's/wlan/eth/' /mnt/root${dev}/lib/systemd/system/dhcpcd.service
  fi
done
rm-busybox-exec <<EOF
  set -e
  cd /mnt
  cp -a rootA/etc/skel/. home/
EOF
echo "Stopping busybox..."
rm-busybox-stop
