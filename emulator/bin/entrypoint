#!/bin/bash
VERSION=${1:?"Usage: entrypoint <version> [--display|--serial]"}
shift
if ! [ -f "/data/${VERSION}.qcow2" ]; then
    initialize-image "$VERSION"
fi
if ! [ -f "/data/rootfs-$VERSION.qcow2" ]; then
    qemu-img create \
      --format qcow2 \
      --backing "/data/${VERSION}.qcow2" \
      --backing-format qcow2 \
      --options compression_type=zstd \
      "/data/rootfs-$VERSION.qcow2" \
      8G
fi
ln -sf "/data/rootfs-$VERSION.qcow2" /rootfs.qcow2
rm-ensure-ssh
if [ "$#" -eq 0 ]; then
    rm-start --detached --wait
    echo "Started!" >/dev/stderr
    rm-exec
    echo "Stopping..." >/dev/stderr
    rm-stop --wait
    shrink-image /rootfs.qcow2
elif [ "$#" -eq 1 ] && [[ "$1" == "--display" ]]; then
    rm-start --detached --wait
    rm2fb-emu 127.0.0.1 8888
    echo "Stopping..." >/dev/stderr
    rm-stop --wait
    shrink-image /rootfs.qcow2
elif [ "$#" -eq 1 ] && [[ "$1" == "--serial" ]]; then
    exec rm-start
else
    rm-start --detached --wait
    rm-exec "$@"
    rm-stop --wait
    shrink-image /rootfs.qcow2
fi
