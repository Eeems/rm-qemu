#!/bin/bash
set -e
STATEDIR=${STATEDIR:-/run/rm}
mkdir -p ${STATEDIR}
if [ "$#" -eq 1 ] && [[ "$1" == "--shell" ]]; then
    exec bash -l
fi
usage="Usage: entrypoint --help
  entrypoint --shell
  entrypoint <version> --serial
  entrypoint <version> [--pause] --display
  entrypoint <version> [--pause] [<command>]..."
if [ "$#" -eq 0 ];then
    echo "$usage"
    exit 1
fi
if [ "$#" -eq 1 ] && [[ "$1" == "--help" ]]; then
    echo "$usage"
    exit
fi
VERSION=$1
shift
rm-ensure-image "$VERSION" || true
VERSION_IMAGE="${DATADIR:-/data}/${VERSION}.qcow2"
if ! [ -f "$VERSION_IMAGE" ]; then
    initialize-image "$VERSION"
fi
IMAGE="${DATADIR:-/data}/rootfs-$VERSION.qcow2"
if ! [ -f "$IMAGE" ]; then
    pushd "${DATADIR:-/data}" >/dev/null
    qemu-img create \
      --format qcow2 \
      --backing "$VERSION_IMAGE" \
      --backing-format qcow2 \
      --options compression_type=zstd \
      "$IMAGE" \
      8G
    popd >/dev/null
fi
ln -sf "$IMAGE" "${STATEDIR}/rootfs.qcow2"
rm-ensure-ssh
if [ "$#" -eq 1 ] && [[ "$1" == "--serial" ]]; then
    exec rm-start
fi
pause=false
if [ "$#" -ge 1 ] && [[ "$1" == "--pause" ]]; then
    pause=true
    shift
fi
trap 'rm-pause || true' EXIT
rm-start --detached --wait
if [ "$#" -eq 0 ]; then
    echo "Started!" >/dev/stderr
    rm-exec
elif [ "$#" -eq 1 ] && [[ "$1" == "--display" ]]; then
    rm2fb-emu 127.0.0.1 8888
else
    rm-exec "$@"
fi
trap - EXIT
if ! $pause;then
    echo "Stopping..." >/dev/stderr
    rm-stop --wait
    shrink-image "$(rm-image-path)"
else
    echo "Pausing..." >/dev/stderr
    rm-pause
fi
