#!/bin/bash
set -e
STATEDIR=${STATEDIR:-/run/rm}
mkdir -p ${STATEDIR}
if [ "$#" -eq 1 ] && [[ "$1" == "--shell" ]]; then
    exec bash -l
fi
usage="Usage: entrypoint --help
  entrypoint --shell
  entrypoint <version> --serial
  entrypoint <version> [--pause] --display
  entrypoint <version> [--pause] [<command>]..."
if [ "$#" -eq 0 ]; then
    echo "$usage"
    exit 1
fi
if [ "$#" -eq 1 ] && [[ "$1" == "--help" ]]; then
    echo "$usage"
    exit
fi
rm-select "$1"
shift
if ! rm-is-paused; then
    echo "Ensuring SSH key is configured..."
    rm-ensure-ssh
fi
if [ "$#" -eq 1 ] && [[ "$1" == "--serial" ]]; then
    exec rm-start </dev/stdin >/dev/stdout 2>/dev/stderr
fi
pause=false
if [ "$#" -ge 1 ] && [[ "$1" == "--pause" ]]; then
    pause=true
    shift
fi
trap 'rm-pause || true' EXIT
rm-start --detached --wait
if [ "$#" -eq 0 ]; then
    echo "Started!" >/dev/stderr
    rm-exec </dev/stdin >/dev/stdout 2>/dev/stderr
elif [ "$#" -eq 1 ] && [[ "$1" == "--display" ]]; then
    rm2fb-emu 127.0.0.1 "${RM_EMU_PORT:-8888}"
else
    rm-exec "$@"
fi
trap - EXIT
if ! $pause; then
    echo "Stopping..." >/dev/stderr
    rm-stop --wait
    if rm-has-snapshot running; then
        rm-commit running
    fi
    shrink-image "$(rm-image-path)"
else
    echo "Pausing..." >/dev/stderr
    rm-pause
fi
