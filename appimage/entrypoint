#!/bin/bash
set -e
KERNEL=${KERNEL:?KERNEL environment variable must be specified}
APPDIR="rm-qemu.AppDir"
mkdir -p "${APPDIR}/bin"
cp \
  appimage-entrypoint \
  /usr/local/bin/* \
  "${APPDIR}/bin"
APPDIR="${APPDIR}" \
DESKTOP="rm-qemu.desktop" \
ICON=rm-qemu.png \
MAIN_BIN=appimage-entrypoint \
PATH_MAPPING='
  /usr/bin/supermin:\${SHARUN_DIR}/bin/supermin
  /lib/x86_64-linux-gnu/guestfs/:\${SHARUN_DIR}/lib/guestfs
  /base.qcow2:\${SHARUN_DIR}/base.qcow2
  /dropbear.socket:\${SHARUN_DIR}/dropbear.socket
  /zImage:\${SHARUN_DIR}/zImage
  /qemu.dts:\${SHARUN_DIR}/qemu.dts
  /rm2fb.tar.gz:\${SHARUN_DIR}/rm2fb.tar.gz
  /rm2fb.conf:\${SHARUN_DIR}/rm2fb.conf
  /etc/debian_version:\${SHARUN_DIR}/debian_release
  /etc/os-release:\${SHARUN_DIR}/os-release
' \
PATH_MAPPING_HARDCODED='
  libguestfs.so.0
' \
quick-sharun \
  /usr/bin/qemu-{system-arm,img} \
  /usr/bin/ssh{,-keygen} \
  /usr/bin/{nc,apt,rm2fb-emu} \
  /usr/bin/{guestfish,libguestfs-test-tool,supermin} \
  /usr/bin/{apt-get,dpkg,dpkg-{deb,query,divert}}
cp \
  /{base.qcow2,dropbear.socket,qemu.dtb,zImage,rm2fb.{conf,tar.gz}} \
  /etc/{os-release,debian_version} \
  "$APPDIR"
mkdir -p $APPDIR/lib/x86_64-linux-gnu/guestfs
cp -r \
  /lib/x86_64-linux-gnu/guestfs/. \
  "$APPDIR/lib/guestfs"
APPDIR="${APPDIR}" \
  VERSION="kernel-${KERNEL}" \
  uruntime2appimage
