#!/bin/bash
set -e
KERNEL=${KERNEL:?KERNEL environment variable must be specified}
APPDIR="rm-qemu.AppDir"
rm -rf "${APPDIR}"

# Copy initial files
mkdir -p \
  "${APPDIR}/bin" \
  "$APPDIR/share/rm-qemu"
cp \
  appimage-entrypoint \
  "${APPDIR}/bin"

# Import some helper programs that can be run with sharun
APPDIR="${APPDIR}" \
DESKTOP="rm-qemu.desktop" \
ICON=rm-qemu.png \
MAIN_BIN=appimage-entrypoint \
_tmp_bin=rm-qemu-bin \
_tmp_lib=rm-qemu-lib \
_tmp_share=rm-qemu-share \
quick-sharun \
  /usr/bin/ssh{,-keygen} \
  /usr/bin/{nc,rm2fb-emu}

sed -i -e 's|_tmp_bin=""|_tmp_bin="rm-qemu-bin"|' "${APPDIR}/bin/path-mapping-hardcoded.src.hook"
sed -i -e 's|_tmp_lib=""|_tmp_lib="rm-qemu-lib"|' "${APPDIR}/bin/path-mapping-hardcoded.src.hook"
sed -i -e 's|_tmp_share=""|_tmp_share="rm-qemu-share"|' "${APPDIR}/bin/path-mapping-hardcoded.src.hook"

# Copy static files
cp \
  /{base.qcow2,dropbear.socket,qemu.dtb,zImage,rm2fb.{conf,tar.gz}} \
  "$APPDIR/share/rm-qemu"
cp \
  /usr/local/bin/* \
  "${APPDIR}/bin"

# Create AppImage
APPDIR="${APPDIR}" \
  VERSION="kernel-${KERNEL}" \
  uruntime2appimage
