FROM alpine:latest AS builder

RUN apk add --no-cache \
  build-base \
  make \
  pkgconfig \
  bzip2 \
  wget \
  cpio \
  git

RUN <<EOT
  set -e
  wget https://www.busybox.net/downloads/busybox-1.36.1.tar.bz2
  tar -xf busybox-1.36.1.tar.bz2
  rm busybox-1.36.1.tar.bz2
  mv busybox-1.36.1 /busybox
EOT

WORKDIR /busybox

COPY busybox.config .config

RUN <<EOT
  make -j$(nproc)
  make install
  for f in install/usr/bin/*;do
    ln -s busybox "install/bin/$(basename "$f")"
  done
EOT

FROM scratch

COPY --from=builder /busybox/install/bin/. /
