name: build
on:
  push:
    branches:
      - master
  workflow_dispatch:
permissions:
  packages: write
jobs:
  build:
    name: Build images
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/eeems/arkes-builder:master
      options: >-
        --privileged
        --security-opt seccomp=unconfined
        --security-opt apparmor=unconfined
        --cap-add=SYS_ADMIN
        --cap-add=NET_ADMIN
        --device /dev/fuse
        --tmpfs /tmp
        --tmpfs /run
        --volume=/:/run/host
    steps:
      - name: Checkout the Git repository
        uses: actions/checkout@v4
      - name: Setup container
        run: |
          set -e
          git config --global --add safe.directory $(pwd)
          mkdir -p /github/home/.docker /home/runner
          if [ ! -f /etc/containers/seccomp.json ];then
            cp seccomp.json /etc/containers/seccomp.json
          fi
          if ! [ -f /github/home/.docker/config.json ];then
            echo '{"auths":{}}' > /github/home/.docker/config.json
          fi
          echo "TMPDIR=${{ runner.temp }}" >> "$GITHUB_ENV"
          ln -s /__w /home/runner/work
      - name: Login to ghcr
        uses: redhat-actions/podman-login@v1
        with:
          username: ${{github.actor}}
          password: ${{ secrets.GITHUB_TOKEN }}
          registry: ghcr.io
          auth_file_path: /run/containers/0/auth.json
      - name: Free up space
        run: |
          chroot /run/host /bin/bash -x <<'EOF'
            df -h
            echo
            echo Freeing up space
            docker system prune --force
            docker rmi $(docker image ls -aq) || true
            docker system prune --force
            export DEBIAN_FRONTEND="noninteractive"
            sudo apt-get autoremove -y
            sudo apt-get autoclean -y
            sudo rm -vrf \
              /usr/lib/jvm \
              /usr/share/dotnet \
              /usr/share/swift \
              /usr/local/.ghcup \
              /usr/local/julia* \
              /usr/local/lib/android \
              /usr/local/share/chromium \
              /opt/microsoft /opt/google \
              /opt/az \
              /usr/local/share/powershell \
            | wc -l
            echo
            df -h
          EOF
      - name: Build
        run: make
      - name: rootfs cache
        uses: actions/cache@v4
        with:
          key: rootfs-${{ hashFiles('kernel/**', 'rootfs/**', 'emulator/**') }}
          path: |
            emulator/.cache
            emulator/.data
      - name: Test
        run: make test
      - name: push
        run: make push
